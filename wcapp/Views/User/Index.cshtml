@using WCAPP.Models.Database
@using WCAPP.Utils
@model List<User>

<div style="border: 1px solid #eee; padding: 10px;">
    <div class="tabbable">
        <!-- Only required for left/right tabs -->
        <ul class="nav nav-tabs">
            <li class="active" id="tah1">
                <a style="font-size: 16px" href="#tab1" data-toggle="tab">员工信息</a>
            </li>
            <li id="tah2">
                <a style="font-size: 16px" href="#tab2" data-toggle="tab">批量导入员工信息</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="tab1">
                <table class="table table-striped table-hover text-center">
                    <thead>
                        <tr>
                            <th>
                                <div class="text-left">
                                    @using (Html.BeginForm("Index", "User", new { PageNo = ViewBag.PageNo }))
                        {
                            @:员工姓名：@Html.TextBox("searchName")@*@Html.DropDownList("id", (SelectList)ViewBag.Pagelist)*@
                            <input type="submit" value="检索" />
            }
                                </div>
                            </th>
                        </tr>
                    </thead>

                </table>
                <table class="table table-striped table-hover text-center">
                    <thead>
                        <tr>
                            <th class="text-center">
                                <input type="checkbox" name="checkAll()" onclick="checkAll()" value="全选" />
                                <button style="padding: 2px 6px 0 6px; font-size: 10px" class="btn btn-primary" onclick="batchUser()">批量生成二维码</button>
                            </th>
                            <th class="text-center">工号</th>
                            <th class="text-center">姓名</th>
                            <th class="text-center">性别</th>
                            <th class="text-center">部门</th>
                            <th class="text-center">岗位</th>
                            <th class="text-center">权限</th>
                            <th class="text-center">操作</th>
                            <th class="text-center">操作</th>
                            <th class="text-center">操作</th>
                            <th class="text-center">操作</th>                            
                            <th class="text-center">
                                <button style="padding: 2px 6px 0 6px; font-size: 10px" class="btn btn-primary" onclick="importUserExcel()">批量导出Excel</button>
                            </th>
                        </tr>
                    </thead>

                    <tbody>
                        @{


                foreach (User user in Model)
                {
                        <tr>
                            <td><input type="checkbox" name="userIds" value="@user.Id" /></td>
                            <td>@user.Id</td>
                            <td>@user.Name</td>
                            <td>@user.Sex</td>
                            <td>@user.Department</td>
                            <td>@user.Position</td>
                            <td>@user.Authorities.Joint("，", x => x.ToString())</td>
                            <td>
                                @Html.ActionLink("编辑", "Modify", new { userId = user.Id, pageNo = (int)ViewBag.pageNo }, new { @class = "btn btn-primary", style = "padding: 2px 6px 0 6px; font-size: 13px" })
                                                               
                            </td>
                            <td>
                                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn btn-danger" onclick="delUser('@user.Id')">删除</button>
                            </td>
                            <td>
                                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn btn-primary" onclick="modifyPassWord('@user.Id')">重置密码</button>
                            </td>
                            <td>
                                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn btn-primary" onclick="QRcode('@user.Id')">二维码信息</button>
                            </td>
                            <td>
                                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn btn-primary" onclick="excelUser('@user.Id')">导出Excel</button>
                            </td>
                        </tr>
                    <div id="@("delete-user" + user.Id)" style="display: none">
                        <div style="margin: 20px; font-size: 15px;">
                            <label><input id="@("checker-box"+user.Id)" onclick="DeleteUser('@user.Id')" type="checkbox">确定删除</label>
                        </div>
                        <div class="text-center">
                            <div style="display: inline-block">
                                @using (Ajax.BeginForm("DeleteUser", new { id = user.Id }, new AjaxOptions { OnSuccess = "onSimple" }))
                    {
                        <input id="delete-prid" type="hidden" name="proNo" value="10" />
                        <input id="confirmDelete" disabled="disabled" class="btn btn-primary" type="submit" value="确认删除" />
        }
                            </div>
                            <button class="btn btn-info" onclick="$('#@("delete-user" + user.Id)').dialog('close')">取消</button>

                        </div>
                    </div>

                    <div id="@("modify-password" + user.Id)" style="display: none">
                        <div class="text-center">
                            <div style="display: inline-block">
                                @using (Ajax.BeginForm("ResetPassword", new { id = user.Id }, new AjaxOptions { OnSuccess = "onSimple" }))
                    {
                        <input id="modifypassword" class="btn btn-primary" type="submit" value="确认" />
        }
                            </div>
                            <button class="btn btn-info" onclick="$('#@("modify-password" + user.Id)').dialog('close')">取消</button>

                        </div>
                    </div>
    }

                        }
                    </tbody>
                </table>

                <div style="display:inline-block;float:left">
                    @using (Html.BeginForm("Index", "User"))
        {
            @:页码：@Html.DropDownList("pageSize", (SelectList)ViewBag.PageSize)<input type="submit" value="Go" />
}
                </div>
                <div style="margin: 0 auto; text-align: right;">
                    共<font color="red"> @ViewBag.PageCount </font>页，当前是第<font style="color:red"> @ViewBag.PageNo </font>页
                    @Html.ActionLink("首页", "Index", new { pageNo = 1, searchName = ViewBag.SearchName, pageSize = ViewBag.PageSizes })
                    @Html.ActionLink("上一页", "Index", "User", new { pageNo = (int)ViewBag.PageNo - 1, searchName=ViewBag.SearchName, pageSize= ViewBag.PageSizes }, null)
                    @Html.ActionLink("下一页", "Index", "User", new { pageNo = (int)ViewBag.NextPageNo, searchName = ViewBag.SearchName, pageSize = ViewBag.PageSizes }, null)
                    @Html.ActionLink("尾页", "Index", new { pageNo = (int)ViewBag.PageCount, searchName = ViewBag.SearchName, pageSize = ViewBag.PageSizes })

                </div>
                
                <div style="display:inline-block;float:right">
                    @using (Html.BeginForm("Index", "User"))
        {
            @:转到：@Html.DropDownList("pageNo", (SelectList)ViewBag.Pagelist)<input type="submit" value="Go" />
}
                </div>
                <div style="margin: 0 auto; text-align: center;float:none">
                    @Html.ActionLink("添加员工", "Add", "User", new { }, new { @class = "btn btn-primary" })
                </div>

            </div>
            <div class="tab-pane" id="tab2">
                <form id="excel" method="post" action="@Url.Action("SuccessExcel")" onsubmit=" return submitExcel()">
                    <div>
                        请选择EXCEL文件
                        <div style="padding: 10px">
                            <input type="file" name="file" accept="application/vnd.ms-excel">
                        </div>
                    </div>
                    <input type="submit" class="btn btn-primary" value="导入">
                </form>
            </div>           
        </div>
    </div>
</div>
@section scripts {
<script>

        function delUser(no) {
            $("#checker-box"+no)[0].checked = false;
            $("#confirmDelete").addClass("disabled");
            $("#delete-user" + no).dialog({ width: "300px", modal: true });
            $("#delete-prid").val(no);
        }
        function DeleteUser(no) {
            $("#checker-box"+no).change(function () {
                var diss = $("input#confirmDelete");
                if (this.checked) {
                    diss.removeClass("disabled");
                    diss.removeAttr("disabled");
                } else {
                    diss.addClass("disabled");
                    diss.attr("disabled", "disabled");
                }
            });
        }
       
        function modifyPassWord(id) {
            $("#modify-password" + id ).dialog({ width: "300px"});
        }

        function modifyUser(sid) {
            $("#modify-user" + sid).dialog({ width: "300px" });
        }

        function submitExcel() {
            $("#excel").ajaxSubmit({
                url: "@Url.Action("SuccessExcel")",
                type: "post",
                resetForm:true,
                success: function(data) {
                    data = JSON.parse(data);
                    if (data.succeed) {
                        alert("导入成功");
                        window.location.href = "@Url.Action("Index","User")";
                    } else if (data.error) {
                        alert(data.error);
                    } else {
                       alert("出现错误");
                    }
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            });

            //不返回false会再进行一次非AJAX提交
            return false;
    }
    function checkAll() {

    }
    //checkbox 全选/取消全选
    var isCheckAll = false;
    function checkAll() {
        if (isCheckAll) {
            $("input[type='checkbox']").each(function () {
                this.checked = false;
            });
            isCheckAll = false;
        } else {
            $("input[type='checkbox']").each(function () {
                this.checked = true;
            });
            isCheckAll = true;
        }
    }
        //QRcode
    function QRcode(ids) {
        var w = window.open();
        var id = ids + ",";
        w.location.href  = '@Url.Action("GetUserPdfs")' +'/'+ id;
    }
    function batchUser() {
        var id = document.getElementsByName("userIds");
        var value = new Array();
        for (var i = 0; i < id.length; i++) {
            if (id[i].checked)
                value.push(id[i].value);
        }
        var w = window.open();
        var userId = "";
        for (var i = 0; i < value.length; i++) {
            userId += value[i] + ",";
        }       
        var userIds = userId.lastIndexOf(",");
        var id = userId.substring(0, userIds);
        
        w.location.href = '@Url.Action("GetUserPdfs")' + '/' + id;
    }
    function excelUser(ids) {
        var w = window.open();
        var userIdes = ids + ",";
        w.location.href = '@Url.Action("ImportUserExcel")' + '?' + 'userIdes' + '=' + userIdes;       
    }
    function importUserExcel() {
        var id = document.getElementsByName("userIds");
        var value = new Array();
        for (var i = 0; i < id.length; i++) {
            if (id[i].checked)
                value.push(id[i].value);
        }
        var w = window.open();
        var userId = "";
        for (var i = 0; i < value.length; i++) {
            userId += value[i] + ",";
        }       
        var userIds = userId.lastIndexOf(",");
        var userIdes = userId.substring(0, userIds);
        
         w.location.href = '@Url.Action("ImportUserExcel")' + '?' + 'userIdes' + '=' + userIdes;       
    }
</script>
}