@using WCAPP.Models.Database
@using WCAPP.Types
@{
    /**/

    Process process = ViewBag.Process;
    IQueryable<Process> history = ViewBag.HistoryProcesses;
    var testStateDict = (Dictionary<int, ProgramTestState>)ViewBag.TestStateDict;
}
<div style="border: 1px solid #eee; padding: 10px;">
    <div class="tabbable">
        <!-- Only required for left/right tabs -->
        <ul class="nav nav-tabs">
            <li class="active">
                <a style="font-size: 16px" href="#tab1" data-toggle="tab">摆渡导出工艺规程</a>
            </li>
            <li>
                <a style="font-size: 16px" href="#tab2" data-toggle="tab">摆渡导入工艺规程</a>
            </li>
            <li>
                <a style="font-size: 16px" href="#tab3" data-toggle="tab">导入已有工艺规程</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="tab1">

                <table class="table table-striped table-hover text-center">
                    <thead>
                        <tr>
                            <th style="display:inline">
                                <div>


                                </div>
                                <div class="searchbox">
                                    <ul class="border1">
                                        <li><a href="#" class="style3">零件号</a></li>
                                        <li><a href="#">编制者</a></li>
                                    </ul>

                                    <div class="bodyss">
                                        <p><input type="text" value="" id="partnoseach2" class="three" placeholder="零件号" /><button class="three1" onclick="PartnoSeach2()">搜索</button></p>
                                        <p><input type="text" value="" id="userseach2" class="four" placeholder="编制者" /><button class="four2" onclick="UserSeach2()">搜索</button></p>

                                    </div>

                                </div>
                                <div class="select_box" style="float:right">

                                    <font>›</font>

                                    <span>摆渡状态</span>

                                    <ul id="testState">

                                        <li>未选择</li>

                                        <li>未导出</li>

                                        <li>已导出</li>

                                    </ul>

                                </div>
                            </th>
                        </tr>
                    </thead>

                </table>
                @using (Ajax.BeginForm("ExportWcapp", "Sync", new AjaxOptions { HttpMethod = "POST", OnSuccess = "downloadWcapp" }))
    {
            <table class="table table-striped table-hover text-center">
                <thead>
                    <tr>
                        <th class="text-center"><input type="checkbox" id="selAll" onclick="swapCheck()" />全选</th>
                        <th class="text-center">工艺规程编号</th>
                        <th class="text-center">版本</th>
                        <th class="text-center">零件号</th>
                        <th class="text-center">零件名称</th>
                        <th class="text-center">试焊状态</th>
                        <th class="text-center">编制者</th>
                        <th class="text-center">摆渡导出时间</th>
                        <th class="text-center">摆渡状态</th>
                        
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.list != null)
        {
            foreach (Process pro in ViewBag.list)
            {
                <tr>
                    <td><input type="checkbox" name="processIds" value="@pro.Id" /></td>
                    <td>@Html.ActionLink(pro.No, "Detail", "Process", new { id = pro.Id }, null)</td>
                    <td>@pro.VersionString</td>
                    <td>@pro.PartNo</td>
                    <td>@pro.PartName</td>
                    <td>@pro.TestState</td>
                    <td>@pro.Author</td>
                    <td>@pro.importTime</td>
                    @if (pro.importState)
        {
            <td><div>已导出</div></td> }
else
{
            <td><div>未导出</div></td>
}

                </tr>
}
}
                </tbody>
            </table>
            <div style="display:inline-block;float:left">
                @Html.DropDownList("pageSizes", (SelectList)ViewBag.PageSize)<input type="button" value="Go" onclick="CroGoPageSize()" />
            </div>
            <div style="margin: 0 auto; text-align: right;">

                共<font color="red"> @ViewBag.PageCount </font>页，当前是第<font style="color:red"> @ViewBag.PageNo </font>页
                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn success" onclick="First('@ViewBag.SearchType','@ViewBag.Search','@ViewBag.PageSizes')">首页</button>
                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn success" onclick="Up('@ViewBag.SearchType','@ViewBag.Search','@ViewBag.PageSizes')">上一页</button>
                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn success" onclick="Down('@ViewBag.SearchType','@ViewBag.Search','@ViewBag.PageSizes')">下一页</button>
                <button style="padding: 2px 6px 0 6px; font-size: 13px" class="btn success" onclick="Last('@ViewBag.SearchType','@ViewBag.Search','@ViewBag.PageSizes')">尾页</button>

            </div>
            <div style="display:inline-block;float:right">
                @Html.DropDownList("croPageNo", (SelectList)ViewBag.Pagelist)<input type="button" value="Go" onclick="CroGoPagelist()" />
            </div>
            <div style="text-align: center">
                <button type="submit" class="btn btn-primary">生成工艺规程文件</button>
            </div>
}



            </div>
            <div class="tab-pane" id="tab2">

                <form id="wcapp" method="post" onsubmit="return uploadWcapp()">
                    <div>
                        请选择WCAPP文件
                        <div style="padding: 10px">
                            <input type="file" name="file">
                        </div>
                        <div style="padding: 10px;float:left">
                            <input type="submit" class="btn btn-primary" onclick="checkWcappFile()" value="校验">
                        </div>
                        <div style="padding: 10px;float:left">
                            <input type="submit" class="btn btn-primary" value="导入">
                        </div>
                    </div>
                </form>
            </div>
            <div class="tab-pane" id="tab3" style="padding-top: 10px">
                <form id="excel" method="post" action="@Url.Action("ImportExcel")" onsubmit="return uploadExcel()">
                    <div>
                        请选择EXCEL文件
                        <div style="padding: 10px">
                            <input type="file" name="file" accept="application/vnd.ms-excel">
                        </div>
                    </div>
                    <input type="submit" class="btn btn-primary" value="导入">
                </form>
            </div>
        </div>
    </div>

    <div id="box" title="请点击链接下载WCAPP文件" style="text-align: center; padding: 20px">
        <a id="link" style="color: red"></a>
    </div>
    <div id="add-seams" title="焊缝对比信息" style="display: none">





    </div>
    @section scripts {

        <link href="~/Content/process.css" rel="stylesheet" />

        <script type="text/javascript">

            var checkFile = false;

            function uploadExcel() {
            $("#excel").ajaxSubmit({
                url: "@Url.Action("ImportExcel")",
                type: "post",
                resetForm:true,
                success: function(data) {
                    data = JSON.parse(data);
                    if (data.succeed) {
                        alert(data.message);
                        window.location.href = "@Url.Action("Index", "Sync")";
                    } else if (data.error) {
                        alert(data.error+data.datas);
                    } else {
                       alert("出现错误");
                    }
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            });

            //不返回false会再进行一次非AJAX提交
            return false;
        }
            function uploadWcapps() {


            }
        function uploadWcapp() {
            $("#wcapp").ajaxSubmit({
                url: checkFile ? "@Url.Action("CheckWcappFile")" : "@Url.Action("ImportWcapp")",
                type: "post",
                resetForm:true,
                success: function(data) {
                    data = JSON.parse(data);
                    if (data.succeed) {
                        alert("操作成功");
                    } else if (data.error) {
                        alert(data.error);
                    } else {
                       alert("出现错误");
                    }
                },
                error: function(err) {
                    alert(JSON.stringify(err));
                }
            });

            checkFile = false;

            //不返回false会再进行一次非AJAX提交
            return false;
        }

        function downloadWcapp(data) {
            if (data.succeed) {
                $("#link").attr("href", "/" + data.path);
                $("#link")[0].innerText = data.name;
                $("#box").dialog({ width: "600px", modal: true });
            }
            }


            function checkWcappFile() {
                checkFile = true;
           }

            function selectAll() {
                var hobbys = document.getElementsByName("processIds");
                if (selAll.checked == true) {
                    for (var i = 0; i < hobbys.length; i++) {
                        hobbys[i].checked = true;
                    }
                } else {
                    for (var i = 0; i < hobbys.length; i++) {
                        hobbys[i].checked = false;
                    }
                }
        }
        //checkbox 全选/取消全选
        var isCheckAll = false;
        function swapCheck() {
            if (isCheckAll) {
                $("input[type='checkbox']").each(function () {
                    this.checked = false;
                });
                isCheckAll = false;
            } else {
                $("input[type='checkbox']").each(function () {
                    this.checked = true;
                });
                isCheckAll = true;
            }
        }

            $(function () {
                $(".bodys p").not(":first").hide();
                $(".searchbox ul li").mouseover(function () {
                    var index = $(this).index();
                    if (index == 0) {
                        $(this).find("a").addClass("style1");
                        $("li").eq(1).find("a").removeClass("style2");
                    }
                    if (index == 1) {
                        $(this).find("a").addClass("style2");
                        $("li").eq(0).find("a").removeClass("style1");
                    }
                    var index = $(this).index();
                    $(".bodys p").eq(index).show().siblings().hide();
                });
            });
            $(function () {
                $(".bodyss p").not(":first").hide();
                $(".searchbox ul li").mouseover(function () {
                    var index = $(this).index();
                    if (index == 0) {
                        $(this).find("a").addClass("style3");
                        $("li").eq(1).find("a").removeClass("style2");
                    }
                    if (index == 1) {
                        $(this).find("a").addClass("style2");
                        $("li").eq(0).find("a").removeClass("style3");
                    }
                    var index = $(this).index();
                    $(".bodyss p").eq(index).show().siblings().hide();
                });
            });
            $(function () {
                $(".bodysss p").not(":first").hide();
                $(".searchbox ul li").mouseover(function () {
                    var index = $(this).index();
                    if (index == 0) {
                        $(this).find("a").addClass("style3");
                        $("li").eq(1).find("a").removeClass("style2");
                    }
                    if (index == 1) {
                        $(this).find("a").addClass("style2");
                        $("li").eq(0).find("a").removeClass("style3");
                    }
                    var index = $(this).index();
                    $(".bodysss p").eq(index).show().siblings().hide();
                });
            });
            $(function () {

                var s_title = $(".select_box span");

                var s_select = $(".select_box li");



                s_title.click(function (e) {

                    $(this).addClass("span_aa");

                    $(this).next("ul").show();

                    e.stopPropagation();

                });



                s_select.click(function () {

                    var s_text = $(this).html();

                    var s_title_2 = $(this).parent('ul').prev("span");

                    s_title_2.html(s_text).removeClass("span_aa");

                    $(this).parent('ul').hide();

                });



                $(document).click(function () {

                    s_title.removeClass("span_aa");

                    $(".select_box ul").hide();

                });



            });
        window.onload = onclickList;
        function onclickList() {
            var list = document.getElementsByTagName("li");
            for (var i = 0; i < list.length; i++) {
                list[i].onclick = (function (i) {
                    return function () {
                        if (list[i].innerText == "已导出") {

                            location.href = "@Html.Raw(Url.Action("Index", new { copPageNo = (int)ViewBag.PageNo, searchType = ViewBag.Publish, search = true, pageSize= (int)ViewBag.PageSizes }))";
                        } if (list[i].innerText == "未导出") {

                            location.href = "@Html.Raw(Url.Action("Index", new { copPageNo = (int)ViewBag.PageNo, searchType = ViewBag.Publish, search = false , pageSize = (int)ViewBag.PageSizes }))";
                        } if (list[i].innerText == "未选择") {

                            location.href = "@Html.Raw(Url.Action("Index", new { copPageNo = (int)ViewBag.PageNo , search = true, pageSize = (int)ViewBag.PageSizes }))";
                        }
                    }
                }(i))
            }
            }
        function PartnoSeach2() {
           var partnoseach = document.getElementById("partnoseach2").value;
            location.href = '@Html.Raw(Url.Action("Index", new { copPageNo = (int)ViewBag.PageNo, searchType = ViewBag.PartNo }))' + '&' + 'search' + '=' + partnoseach;
        }
        function UserSeach2() {
            var userseach = document.getElementById("userseach2").value;
            location.href = '@Html.Raw(Url.Action("Index", new { copPageNo = (int)ViewBag.PageNo, searchType = ViewBag.Author }))' + '&' +'search'+'='+ userseach;
            }
             function GoPageSize() {
            var myselect = document.getElementById("pageSize");
            var index = myselect.selectedIndex;
            var indexs = myselect.options[index].value;

            location.href = '@Html.Raw(Url.Action("Index"))' + '?' +'pageSize' + '=' + indexs;
            }
             function CroGoPageSize() {
            var myselect = document.getElementById("pageSizes");
            var index = myselect.selectedIndex;
            var indexs = myselect.options[index].value;

            location.href = '@Html.Raw(Url.Action("Index"))' + '?' + 'pageSize' + '=' + indexs + '#1';
             }
             function CroGoPagelist() {
            var myselect = document.getElementById("croPageNo");
            var index = myselect.selectedIndex;
            var indexs = myselect.options[index].value;

            location.href = '@Html.Raw(Url.Action("Index"))' + '?' + 'pageNo' + '=' + indexs + '#1';
             }
              function First(SearchType, Search, PageSize) {
            location.href = '@Url.Action("Index", new { pageNo = 1 })' + '&' + 'searchType' + '=' + SearchType + '&' + 'search' + '=' + Search + '&' + 'pageSize' + '=' + PageSize + '#1';
        }
        function Up(SearchType, Search, PageSize) {
            location.href = '@Url.Action("Index", new { pageNo = (int)ViewBag.PrevPageNo })' + '&' + 'searchType' + '=' + SearchType + '&' + 'search' + '=' + Search + '&' + 'pageSize' + '=' + PageSize + '#1';
            }
        function Down(SearchType, Search, PageSize) {
            location.href = '@Url.Action("Index", new { pageNo = (int)ViewBag.NextPageNo })' + '&' + 'searchType' + '=' + SearchType + '&' + 'search' + '=' + Search + '&' + 'pageSize' + '=' + PageSize + '#1';
        }
        function Last(SearchType, Search, PageSize) {
            location.href = '@Url.Action("Index", new { pageNo = (int)ViewBag.PageCount })' + '&' + 'searchType' + '=' + SearchType + '&' + 'search' + '=' + Search + '&' + 'pageSize' + '=' + PageSize + '#1';
        }
        </script>
    }
